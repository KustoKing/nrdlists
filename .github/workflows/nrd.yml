# GitHub Actions Workflow: Automated NRD Domain List Updates and Publishing

name: Update NRD List

on:
  schedule:
    - cron: "10 1,3,5,7,9,11,13,15,17,19,21,23 * * *"  # Every 2 hours
  workflow_dispatch:

permissions:
  contents: write         # Needed to commit changes

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  update-hunter-lists:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python and system dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y unzip
          pip install --upgrade pip requests matplotlib tldextract

      - name: Download feeds
        env:
          NORDOMAIN_30DAY_URL: ${{ secrets.NORDOMAIN_30DAY_URL }}
          NORDOMAIN_14DAY_URL: ${{ secrets.NORDOMAIN_14DAY_URL }}
          PHISHING_30DAY_URL: ${{ secrets.PHISHING_30DAY_URL }}
          PHISHING_14DAY_URL: ${{ secrets.PHISHING_14DAY_URL }}
          ADDITIONAL_SOURCE_URL: ${{ secrets.ADDITIONAL_SOURCE_URL }}
          USER_AGENT: ${{ secrets.USER_AGENT }}
        run: |
          set -euo pipefail
          mkdir -p downloads
          curl -fsS -o downloads/nordomain_30day.txt "$NORDOMAIN_30DAY_URL"
          curl -fsS -o downloads/nordomain_14day.txt "$NORDOMAIN_14DAY_URL"
          curl -fsS -o downloads/phishing_30day.txt "$PHISHING_30DAY_URL"
          curl -fsS -o downloads/phishing_14day.txt "$PHISHING_14DAY_URL"
          curl -fsS -A "$USER_AGENT" -o downloads/additional.txt "$ADDITIONAL_SOURCE_URL"

      - name: Generate and compare hashes
        id: hash
        run: |
          set -euo pipefail
          mkdir -p hash
          CHANGED=0
          for file in nordomain_30day nordomain_14day phishing_30day phishing_14day additional; do
            sha256sum "downloads/$file.txt" > "hash/current_$file.txt"
            if [ ! -f "hash/previous_$file.txt" ] || ! cmp -s "hash/previous_$file.txt" "hash/current_$file.txt"; then
              echo "$file changed"
              CHANGED=1
            fi
          done
          echo "changed=$CHANGED" >> $GITHUB_ENV

      - name: Abort if no input changes detected
        if: env.changed == '0'
        run: echo "No changes detected. Exiting early."

      # --- Only runs if something changed ---
      - name: Run main list processing
        if: env.changed != '0'
        env:
          NORDOMAIN_30DAY_URL: ${{ secrets.NORDOMAIN_30DAY_URL }}
          NORDOMAIN_14DAY_URL: ${{ secrets.NORDOMAIN_14DAY_URL }}
          PHISHING_30DAY_URL: ${{ secrets.PHISHING_30DAY_URL }}
          PHISHING_14DAY_URL: ${{ secrets.PHISHING_14DAY_URL }}
          ADDITIONAL_SOURCE_URL: ${{ secrets.ADDITIONAL_SOURCE_URL }}
          USER_AGENT: ${{ secrets.USER_AGENT }}
        run: |
          set -euo pipefail
          python3 src/nrd-hunter.py

      - name: Apply TLD and Top-1M domain filtering
        if: env.changed != '0'
        run: |
          set -euo pipefail
          # TLD filtering
          curl -fsS -O https://data.iana.org/TLD/tlds-alpha-by-domain.txt
          awk '{print tolower($0)}' tlds-alpha-by-domain.txt > iana-tlds.txt
          for file in output/*.txt; do
            grep -vFxf iana-tlds.txt "$file" > "$file.tmp" && mv "$file.tmp" "$file"
          done
          # Top-1M (same as before)
          mkdir -p top1m
          curl -fsS -o top1m/umbrella.zip "https://s3-us-west-1.amazonaws.com/umbrella-static/top-1m.csv.zip"
          unzip -jo top1m/umbrella.zip '*.csv' -d top1m/
          awk -F, '{print $2}' top1m/*.csv > top1m/umbrella.txt
          curl -fsS -o top1m/builtwith.zip "https://builtwith.com/dl/builtwith-top1m.zip"
          unzip -jo top1m/builtwith.zip '*.csv' -d top1m/
          awk -F, '{print $2}' top1m/*.csv > top1m/builtwith.txt
          curl -fsS -o top1m/tranco.zip "https://tranco-list.eu/top-1m.csv.zip"
          unzip -jo top1m/tranco.zip '*.csv' -d top1m/
          awk -F, '{print $2}' top1m/*.csv > top1m/tranco.txt
          cat top1m/umbrella.txt top1m/builtwith.txt top1m/tranco.txt | sort -u > top1m-blocklist.txt
          for file in output/*.txt; do
            grep -vFxf top1m-blocklist.txt "$file" > "$file.tmp" && mv "$file.tmp" "$file"
          done
          rm -rf top1m iana-tlds.txt tlds-alpha-by-domain.txt

      - name: Move outputs to final locations
        if: env.changed != '0'
        run: |
          set -euo pipefail
          # (reuse your Bash move_if_exists function or Python script here)
          # Example for bash version:
          move_if_exists() {
            src=$1
            dest=$2
            mkdir -p "$dest"
            if [ -f "$src" ]; then
              mv "$src" "$dest"
            else
              echo "Warning: File $src does not exist."
            fi
          }
          # (Your list of moves here, unchanged)

      - name: Generate statistics image
        if: env.changed != '0'
        run: |
          set -euo pipefail
          python3 src/generate-stats.py

      - name: Move statistics image
        if: env.changed != '0'
        run: |
          set -euo pipefail
          mkdir -p img && mv stats.png img/

      - name: Commit & push updates
        if: env.changed != '0'
        run: |
          set -euo pipefail
          git config user.name "KustoKing[bot]"
          git config user.email "gianni@kustoking.com"
          git add lists img/stats.png hash/current_*.txt
          if ! git diff --cached --quiet; then
            DATE=$(date +'%Y%m%d')
            git commit -m "ci: update hunter lists $DATE"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Save hashes for next run
        if: env.changed != '0'
        run: |
          set -euo pipefail
          for file in nordomain_30day nordomain_14day phishing_30day phishing_14day additional; do
            mv "hash/current_$file.txt" "hash/previous_$file.txt"
          done
          git add hash/previous_*.txt
          if ! git diff --cached --quiet; then
            git commit -m "ci: save hashes for next run"
            git push
          else
            echo "No hash changes to commit."
          fi

